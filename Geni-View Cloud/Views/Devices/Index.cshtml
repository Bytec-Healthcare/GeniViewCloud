@model IEnumerable<GeniView.Cloud.Models.DeviceListViewModel>
@using GeniView.Cloud.Models;
@{
    ViewBag.Title = "Devices";
    ViewBag.ShowCommunityAndGroupFilter = true;
}

@section styles {
    <link href="~/Content/devices-batteries.css" rel="stylesheet" type="text/css" />
    <style>
        #DeviceTable_wrapper .dataTables_paginate,
        #DeviceTable_wrapper .dataTables_info {
            display: none !important;
        }
    </style>
}

<div>@Html.ValidationMessage("DbFail", new { @class = "text-danger" })</div>

<div class="page-header-section">
    <h1 class="page-header-title">Devices</h1>
    <div class="header-controls">
        <div class="search-container">
            <i class="fa fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search by Device Serial Number" />
        </div>
        <div class="refresh-container">
            <button class="refresh-btn" title="Refresh">
                <i class="fa fa-sync refresh-icon"></i>
                <span>Refresh</span>
            </button>
        </div>
    </div>
</div>

<div class="table-container">
    <table class="devices-batteries-table" id="DeviceTable">
        <thead>
            <tr>
                <th style="width: 48px;"></th>
                <th class="serial-column">
                    <span class="serial-main">Serial Number</span>
                    <span class="serial-mobile-lines">
                        <span>Device</span>
                        <span>Serial</span>
                        <span>Number</span>
                    </span>
                </th>
                <th>Group</th>
                <th>Last Seen</th>
                <th>Status</th>
                <th>Power</th>
                <th>Soc</th>
                <th>Temperature</th>
                <th>Alerts</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr data-serial-number="@item.SerialNumber">
                        <td value="@item.SerialNumber" class="collapse-col">
                            <i class="fa fa-chevron-right gv-expand-icon" aria-hidden="true"></i>
                        </td>
                        <td class="serial-number">
                            @Html.DisplayFor(modelItem => item.SerialNumber)
                        </td>
                        <td>
                            @(item.Group != null ? item.Group.Name : "--")
                        </td>
                        <td>
                            @if (item.LastSeenOn.HasValue)
                            {
                                @TimeZoneHelper.GetLocalDateTime(item.LastSeenOn.Value)
                            }
                            else
                            {
                                <span>--</span>
                            }
                        </td>
                        <td>
                            @if (item.isOnline)
                            {
                                <span class="status-pill online">
                                    <span class="status-dot"></span>Online
                                </span>
                            }
                            else
                            {
                                <span class="status-pill offline">
                                    <span class="status-dot"></span>Offline
                                </span>
                            }
                        </td>
                        <td>
                            @if (item.isOnline && item.LastAgentDeviceLog != null)
                            {
                                @(Math.Round(item.LastAgentDeviceLog.PowerOutput.Power, 0))<text> W</text>
                            }
                            else
                            {
                                <span>--</span>
                            }
                        </td>
                        <td>
                            @if (item.isOnline && item.Capacity != null)
                            {
                                <text>@item.Capacity.Name% </text>
                            }
                            else
                            {
                                <span>--</span>
                            }
                        </td>
                        <td>
                            @if (item.isOnline && item.Temperature != null)
                            {
                                var temp = int.Parse(item.Temperature.Name);
                                <span class="temperature">
                                    <i class="fa fa-thermometer-half temp-icon"></i>
                                    @temp°C
                                </span>
                            }
                            else
                            {
                                <span>--</span>
                            }
                        </td>
                        <td class="text-center">
                            @if (item.isOnline && item.Alert != null)
                            {
                                @item.Alert.Name
                            }
                            else
                            {
                                <span>--</span>
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                @if (User.IsInRole("Application Admin"))
                                {
                                    @Html.ActionLink("History", "History", new { id = item.ID }, new { @class = "action-btn history" })
                                }
                                @Html.ActionLink("Graphs", "Graphs", new { id = item.ID }, new { @class = "action-btn graphs" })
                                @Html.ActionLink("Events", "Events", new { id = item.ID }, new { @class = "action-btn events" })
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <div class="pagination-container">
        <div class="pagination-info">Showing 1 to 10 of 1 entries</div>
        <div class="pagination-controls">
            <button class="pagination-btn prev" disabled>
                <i class="fa fa-chevron-left"></i> Previous
            </button>
            <div class="page-numbers">
                <button class="pagination-btn page-num active" data-page="0">1</button>
                <button class="pagination-btn page-num" data-page="1">2</button>
                <button class="pagination-btn page-num" data-page="2">3</button>
                <button class="pagination-btn page-num" data-page="3">4</button>
            </div>
            <button class="pagination-btn next">
                Next <i class="fa fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

@section scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript" src="~/Scripts/Custom Scripts/jquery.circliful.min.js"></script>
    <script type="text/javascript">
        var table;

        function Initable() {
            table = $('#DeviceTable').DataTable({
                responsive: { details: false },
                dom: 't',
                pagingType: 'simple_numbers',
                pageLength: 10,
                searching: true,
                ordering: true,
                info: false,
                autoWidth: false,
                columnDefs: [
                    { type: 'date', targets: 3 },
                    { searchable: false, orderable: false, targets: [0, -1] },
                    { responsivePriority: 1, targets: -1 },
                    { responsivePriority: 2, targets: [1, 2, 3, 4] }
                ],
                drawCallback: function () {
                    updatePagination(this.api());
                }
            });

            $('#DeviceTable tbody').on('click', 'td.collapse-col', function (e) {
                e.stopPropagation();
                var serialNumber = $(this).attr('value');
                if (serialNumber && serialNumber.length > 0) {
                    var tr = $(this).closest('tr');
                    var $icon = $(this).find('.gv-expand-icon');
                    var row = table.row(tr);

                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                        $icon.removeClass('fa-chevron-up expanded').addClass('fa-chevron-right');
                    } else {
                        tr.addClass('shown');
                        if (tr.hasClass('data-obtained')) {
                            row.child.show();
                            $icon.removeClass('fa-chevron-right').addClass('fa-chevron-up expanded');
                        } else {
                            $icon.removeClass('fa-chevron-right').addClass('fa-sync fa-spin');
                            $.get('/Devices/GetDeviceDetailsData?ID=' + serialNumber, function (viewdata) {
                                $icon.removeClass('fa-sync fa-spin').addClass('fa-chevron-up expanded');
                                row.child('<div class="details-content">' + viewdata + '</div>', 'details-row').show();
                                tr.addClass('data-obtained');
                                drawCircle(serialNumber);
                                drawBayCircle(serialNumber);
                            });
                        }
                    }
                }
            });

            $('.search-input').on('keyup', function () {
                table.search(this.value).draw();
            });

            $('.refresh-btn').on('click', function () {
                location.reload();
            });
        }

        function drawCircle(target) {
            if (!target) return;
            var powerOut = '#powerOut-' + target;
            var powerIn = '#powerIn-' + target;
            $(powerOut).html('').circliful();
            $(powerIn).html('').circliful();
        }

        function drawBayCircle(id) {
            if (!id) return;
            $.ajax({
                url: '/Devices/GetDeviceBayData?serialNumber=' + id,
                success: function (JData) {
                    var baycount = JData.BayCount || 0;
                    if (baycount <= 0) {
                        return;
                    }
                    var circleSize = 150;
                    for (var i = 1; i <= baycount; i++) {
                        var divName = '#bayGraph' + i + '-' + id;
                        var divPlaceholder = '#bay' + i + '-' + id;
                        $(divPlaceholder).addClass('col-md-' + Math.floor(12 / baycount));
                        $(divName).attr({
                            'data-dimension': circleSize,
                            'data-bgcolor': '#eee',
                            'data-fill': '#fff',
                            'data-total': 100,
                            'data-animationstep': 5,
                            'data-fgcolor': '#0f0',
                            'data-width': 8,
                            'data-info': JData.SerialNumber[i - 1],
                            'data-info0': 'BAY ' + i,
                            'data-bordersize': 5,
                            'data-fontsize': 22,
                            'data-text': JData.Capacity[i - 1],
                            'data-part': parseInt(JData.Capacity[i - 1], 10)
                        });
                        $(divName).html('').circliful();
                    }
                    if (JData.Capacity && JData.Capacity.length > 0) {
                        var batteryPercentDisplay = JData.Capacity.find(function (value) {
                            return value && value !== 'Empty' && value !== 'No Info' && value !== 'Sync Error';
                        }) || JData.Capacity[0];
                        if (batteryPercentDisplay) {
                            $('#batteryPercent-' + id).text(batteryPercentDisplay);
                        }
                    }
                },
                async: false
            });
        }

        function updatePagination(tableApi) {
            if (!tableApi) {
                tableApi = table;
            }
            var info = tableApi.page.info();
            var currentPage = info.page;
            var totalPages = info.pages;

            $('.pagination-info').text(
                'Showing ' + (info.start + 1) + ' to ' + info.end + ' of ' + info.recordsTotal + ' entries'
            );

            $('.pagination-btn.prev').prop('disabled', currentPage === 0);
            $('.pagination-btn.next').prop('disabled', currentPage === totalPages - 1);

            renderPageNumbers(currentPage, totalPages);
        }

        function renderPageNumbers(currentPage, totalPages) {
            var container = $('.page-numbers');
            container.empty();

            if (totalPages <= 0) {
                return;
            }

            var maxButtons = 4;
            var startPage = Math.max(0, currentPage - Math.floor(maxButtons / 2));
            var endPage = Math.min(totalPages - 1, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(0, endPage - maxButtons + 1);
            }

            for (var i = startPage; i <= endPage; i++) {
                var btn = $('<button>')
                    .addClass('pagination-btn page-num')
                    .attr('data-page', i)
                    .text(i + 1);

                if (i === currentPage) {
                    btn.addClass('active');
                }

                container.append(btn);
            }
        }

        $(document).ready(function () {
            Initable();

            $('.pagination-btn.prev').on('click', function () {
                if (!$(this).prop('disabled')) {
                    table.page('previous').draw('page');
                }
            });

            $('.pagination-btn.next').on('click', function () {
                if (!$(this).prop('disabled')) {
                    table.page('next').draw('page');
                }
            });

            $(document).on('click', '.pagination-btn.page-num', function () {
                var pageNum = $(this).data('page');
                table.page(pageNum).draw('page');
            });
        });
    </script>
}
