@{
    ViewBag.Title = "Device Events";
    ViewBag.ShowCommunityAndGroupFilter = true;
}

@section styles {
    <style>
        .device-events-page {
            width: 100%;
        }

        /* Blue bar behind title (UX) */
        .device-events-bar {
            width: 100%;
            min-height: 54px;
            background: rgba(211, 215, 245, 0.78);
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 13px 21px;
            box-sizing: border-box;
        }

        .device-events-title {
            font-family: "Instrument Sans", sans-serif;
            font-weight: 600;
            font-size: 22px;
            line-height: 1;
            letter-spacing: 0;
            color: #1f2937;
        }

        .device-events-title span {
            font-family: "Instrument Sans", sans-serif;
            font-weight: 500;
            font-size: 22px;
            line-height: 1;
            letter-spacing: 0;
            color: #6b7280;
            margin-left: 8px;
        }

        .device-events-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-events-actions .fa {
            color: #3e4cc1;
        }

        .device-events-card {
            background: #fff;
            border-radius: 18px;
            border: 1px solid rgba(68, 68, 68, 0.4);
            box-shadow: 0 4px 4px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            padding: 20px 20px 28px;
            box-sizing: border-box;
        }

        .device-events-card__body {
            margin-top: 14px;
        }

        #DeviceEventHistoryContainerLoading {
            min-height: 520px;
        }

        /* table wrapper to have rounded border like UX */
        .device-events-tablewrap {
            border-radius: 18px;
            border: 1px solid rgba(68, 68, 68, 0.4);
            overflow: hidden;
        }

        #DeviceEventHistory .table {
            margin-bottom: 0;
        }

        #DeviceEventHistory table thead th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 2;
        }

        /* DataTables info/pager alignment */
        #DeviceEventHistory .dt-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 10px 0 0;
        }

        #DeviceEventHistory .dataTables_info {
            padding: 0;
            color: #6b7280;
            font-weight: 600;
            font-size: 12px;
        }

        #DeviceEventHistory .dataTables_paginate {
            padding: 0;
        }

        #DeviceEventHistory .paginate_button {
            border-radius: 4px !important;
            border: 1px solid rgba(62, 76, 193, 0.35) !important;
            background: #fff !important;
            color: #3e4cc1 !important;
            margin-left: 4px;
            margin-right: 4px;
            padding: 6px 10px !important;
            font-weight: 700;
            font-size: 12px;
        }

        #DeviceEventHistory .paginate_button.current {
            background: rgba(62, 76, 193, 0.12) !important;
            border-color: rgba(62, 76, 193, 0.35) !important;
            color: #3e4cc1 !important;
        }

        #DeviceEventHistory .paginate_button.disabled {
            opacity: 0.5;
            cursor: default !important;
        }
    </style>
}

@section scripts{
    <script type="text/javascript">
        var g_refreshtTime = 10000;
        var g_refreshTimer = null;
        var g_pauseAutoRefreshUntil = 0;

        function pauseAutoRefresh(ms) {
            g_pauseAutoRefreshUntil = Date.now() + (ms || 15000);
        }

        function canAutoRefresh() {
            if (Date.now() < g_pauseAutoRefreshUntil) return false;

            // If DataTables is initialized and the user is not on page 1, don't auto refresh.
            try {
                if ($.fn.DataTable && $.fn.DataTable.isDataTable('#DeviceEventTable')) {
                    var dt = $('#DeviceEventTable').DataTable();
                    return dt.page() === 0;
                }
            } catch (e) { }
            return true;
        }

        function scheduleRefresh() {
            if (g_refreshTimer) {
                clearTimeout(g_refreshTimer);
            }
            g_refreshTimer = setTimeout(function () {
                if (canAutoRefresh()) {
                    GetDeviceEventHistory();
                } else {
                    scheduleRefresh();
                }
            }, g_refreshtTime);
        }

        function GetDeviceEventHistory() {
            $.ajax({
                type: 'GET',
                dataType: 'html',
                url: '@Url.Action("GetDeviceEventHistory", "DeviceEvents")',
                success: function (data) {
                    $('#DeviceEventHistory').html(data);
                },
                error: function (result) {
                    $('#DeviceEventHistory').html(result.statusText);
                },
                complete: function () {
                    $("#DeviceEventHistoryContainerLoading").removeClass("panelBodyLoading");
                    scheduleRefresh();
                }
            });
        }

        function RefreshPage() {
            location.reload();
        }

        $(document).ready(function () {
            // Pause refresh on user interactions with paging controls / table
            $(document).on('click', '#DeviceEventHistory .paginate_button', function () { pauseAutoRefresh(15000); });
            $(document).on('mousedown keydown wheel touchstart', '#DeviceEventHistory', function () { pauseAutoRefresh(15000); });

            GetDeviceEventHistory();
        });
    </script>
}

<div class="device-events-page">
    <div>@Html.ValidationMessage("DbFail", new { @class = "text-danger" })</div>

    <div class="device-events-bar">
        <div class="device-events-title">
            Device Events <span>(Latest 50)</span>
        </div>
        <div class="device-events-actions">
            <span class="fa fa-sync" onclick="RefreshPage()" title="Refresh" aria-hidden="true" style="cursor:pointer;"></span>
            <span class="fa fa-bell" title="Notifications" aria-hidden="true"></span>
        </div>
    </div>

    <div style="height: 12px;"></div>

    <div class="device-events-card">
        <div class="device-events-card__body">
            <div class="device-events-tablewrap">
                <div id="DeviceEventHistoryContainerLoading" class="panelBodyLoading">
                    <div id="DeviceEventHistory" style="width:100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>