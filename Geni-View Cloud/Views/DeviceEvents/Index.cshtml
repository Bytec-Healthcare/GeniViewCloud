@{
    ViewBag.Title = "Device History";
    ViewBag.ShowCommunityAndGroupFilter = true;
}

@section styles {
    <link href="~/Content/Custom/devices-batteries.css" rel="stylesheet" type="text/css" />
    <style>

        /* ===== DEVICE EVENTS BAR ===== */
        .device-events-bar {
            height: 40px;
            background: #E6E9FB;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 16px;
        }

        .device-events-title {
            font-family: Instrument Sans, sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #3E4CC1;
        }

            .device-events-title span {
                font-weight: 500;
                color: #6B7280;
                margin-left: 6px;
            }

        .device-events-actions {
            margin-left: auto;
            display: flex;
            gap: 12px;
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: #4f46e5;
            cursor: pointer;
            padding: 0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

            .refresh-btn:hover {
                color: #3b33cc;
            }

        .refresh-icon {
            font-size: 14px;
        }

        /* ===== CARD CONTAINER (FIGMA MATCH) ===== */
        .device-events-card {
            /* keep design, but allow responsive width like Devices/Batteries */
            width: 100%;
            max-width: 1500px;
            background: #FFFFFF;
            border-radius: 18px;
            border: 1px solid rgba(68,68,68,0.4);
            box-shadow: 0 4px 4px rgba(0,0,0,0.25);
            padding: 20px 20px 28px;
            min-height: calc(100vh - 190px);
            box-sizing: border-box;
        }

        .device-events-tablewrap {
            border-radius: 18px;
            border: none;
            overflow: visible;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Ensure the DataTables wrapper/footer/pager follows container width
           (important when sidebar expands/collapses) */
        #DeviceEventHistory,
        #DeviceEventHistory .dataTables_wrapper,
        #DeviceEventHistory table {
            width: 100% !important;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* ===== TABLE ===== */
        .device-events-table {
            width: 100%;
            border-collapse: collapse;
        }

            .device-events-table thead th {
                height: 44px;
                padding: 0 16px;
                line-height: 1.2;
                font-size: 18px;
                font-weight: 700;
                color: #2F2F2F;
                border-bottom: 1px solid rgba(68,68,68,0.4);
                text-align: left;
            }

            .device-events-table tbody td {
                height: 44px;
                padding: 0 16px;
                line-height: 1.2;
                font-size: 18px;
                font-weight: 500;
                color: #4B5563;
                vertical-align: middle;
            }

        .evt-time-fa {
            color: #6B7280;
            font-size: 14px;
            line-height: 1;
        }

        /* ===== COLUMN WIDTHS (FROM FIGMA) ===== */
        .col-serial {
            width: 185px;
        }

        .col-desc {
            width: 101px;
        }

        .col-type {
            width: 124px;
        }

        .col-source {
            width: 61px;
        }

        .col-time {
            width: 193px;
            text-align: right;
        }

        /* ===== ICON + TEXT ===== */
        .cell-flex {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .icon-device {
            flex-shrink: 0;
        }

        .icon-info {
            flex-shrink: 0;
        }

        /* ===== Device Events Table ===== */
        .device-events-table {
            width: 100%;
            border-collapse: collapse;
        }

            .device-events-table td,
            .device-events-table th {
                white-space: nowrap;
                vertical-align: middle;
            }

        .cell-flex {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .icon-device {
            width: 20px;
            height: 21.67px;
            flex-shrink: 0;
        }

        .icon-info {
            width: 6.43px;
            height: 16px;
            flex-shrink: 0;
        }

        .cell-flex span {
            line-height: 1;
            display: inline-block;
        }

        /* ===== DATATABLES FOOTER ===== */
        .dt-footer {
            width: 100%;
            box-sizing: border-box;
            margin-top: 8px;
        }

        .dataTables_info {
            font-size: 12px;
            color: #6B7280;
        }

        .paginate_button {
            min-width: 28px;
            height: 28px;
            padding: 0 8px !important;
            border-radius: 4px;
            border: 1px solid rgba(62,76,193,0.35) !important;
            background: #FFFFFF !important;
            color: #3E4CC1 !important;
            font-weight: 600;
            font-size: 12px;
        }

            .paginate_button.current {
                background: rgba(62,76,193,0.12) !important;
            }

        .dt-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
            padding: 8px 12px;
            border-top: 1px solid rgba(68,68,68,0.20);
        }

        .dt-info {
            color: #6B7280;
            font-size: 12px;
            white-space: nowrap;
        }

        .dt-pager {
            white-space: nowrap;
        }

        body:not(.admin-area) #wrapper.toggled.sidebar-expanded .device-events-card,
        body:not(.admin-area) #wrapper.toggled.sidebar-collapsed .device-events-card {
            max-width: none; /* full width in both states (match Devices/Batteries) */
        }

        body:not(.admin-area) #wrapper.toggled.sidebar-collapsed #DeviceEventHistory .dataTables_wrapper,
        body:not(.admin-area) #wrapper.toggled.sidebar-expanded #DeviceEventHistory .dataTables_wrapper {
            width: 100% !important;
        }
    </style>
}

@section scripts {
    <script>
        var refreshMs = 10000;
        var refreshTimer;

        function tryAdjustDeviceEventsDataTable() {
            if (!$.fn.DataTable) return;

            var table = $('#DeviceEventHistory').find('#DeviceEventTable');
            if (!table.length) return;

            if ($.fn.DataTable.isDataTable(table)) {
                try {
                    table.DataTable().columns.adjust();
                } catch (e) {
                }
            }
        }

        function bindSidebarToggleAdjustOnce() {
            var toggleBtn = document.getElementById('sidebar-toggle');
            if (!toggleBtn || toggleBtn.__gvDeviceEventsBound) return;

            toggleBtn.__gvDeviceEventsBound = true;

            toggleBtn.addEventListener('click', function () {
                window.setTimeout(function () {
                    tryAdjustDeviceEventsDataTable();
                }, 600);
            });
        }

        function loadDeviceEvents() {
            $.get('@Url.Action("GetDeviceEventHistory", "DeviceEvents")', function (html) {
                $('#DeviceEventHistory').html(html);

                window.setTimeout(function () {
                    tryAdjustDeviceEventsDataTable();
                }, 0);
            }).always(scheduleRefresh);
        }

        function scheduleRefresh() {
            clearTimeout(refreshTimer);
            refreshTimer = setTimeout(loadDeviceEvents, refreshMs);
        }

        $(document).ready(function () {
            bindSidebarToggleAdjustOnce();

            $(window).on('resize', function () {
                tryAdjustDeviceEventsDataTable();
            });

            loadDeviceEvents();

            $('.refresh-btn').on('click', function () {
                location.reload();
            });
        });
    </script>
}

<div class="device-events-bar">
    <div class="device-events-title">
        Device Events <span>(Latest 50)</span>
    </div>
    <div class="device-events-actions">
        <div class="refresh-container">
            <button class="refresh-btn" type="button" title="Refresh">
                <i class="fa fa-sync refresh-icon" aria-hidden="true"></i>
                <span>Refresh</span>
            </button>
        </div>
    </div>
</div>

<div style="height:12px"></div>

<div class="device-events-card">
    <div class="device-events-tablewrap">
        <div id="DeviceEventHistory"></div>
    </div>
</div>